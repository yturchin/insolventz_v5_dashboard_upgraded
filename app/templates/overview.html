{% extends "base.html" %}

{% block content %}
<div class="page">
  <div class="header">
    <div>
      <h1>Dashboard</h1>
      <div class="subtle">Case: <strong id="caseLabel">{{ selected_case_id }}</strong></div>
    </div>
    <div class="case-switch">
      <form method="get" action="/">
        <label for="case_id" class="subtle">Case</label>
        <select name="case_id" id="case_id" onchange="this.form.submit()">
          {% for c in cases %}
            <option value="{{ c.case_id }}" {% if c.case_id == selected_case_id %}selected{% endif %}>
              {{ c.case_id }} — {{ c.company_name }}
            </option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  <div class="kpis" id="kpis">
    <div class="card kpi">
      <div class="kpi-title">Total inflows</div>
      <div class="kpi-value" id="kpiInflows">—</div>
    </div>
    <div class="card kpi">
      <div class="kpi-title">Total outflows</div>
      <div class="kpi-value" id="kpiOutflows">—</div>
    </div>
    <div class="card kpi risk" id="kpiSuspiciousCard">
      <div class="kpi-title">Suspicious amount</div>
      <div class="kpi-value" id="kpiSuspicious">—</div>
      <div class="kpi-meta" id="kpiOpenHits">—</div>
    </div>
    <div class="card kpi">
      <div class="kpi-title">Coverage</div>
      <div class="kpi-value" id="kpiCoverage">—</div>
      <div class="kpi-meta" id="kpiGap">—</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-title">Monthly cashflow</div>
      <canvas id="cashflowChart" height="130"></canvas>
    </div>
    <div class="card">
      <div class="card-title">Risk distribution</div>
      <canvas id="riskChart" height="130"></canvas>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-title">Suspicious trend</div>
      <canvas id="susTrendChart" height="130"></canvas>
    </div>
    <div class="card">
      <div class="card-title">Notice lifecycle</div>
      <div class="lifecycle">
        <div class="lc-row"><span>Draft</span><span id="lcDraft">0</span></div>
        <div class="lc-row"><span>Generated</span><span id="lcGenerated">0</span></div>
        <div class="lc-row"><span>Accepted</span><span id="lcAccepted">0</span></div>
        <div class="lc-row"><span>Sent</span><span id="lcSent">0</span></div>
        <div class="progress">
          <div class="progress-bar" id="lcProgress" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-title">Top counterparties</div>
      <canvas id="cpChart" height="160"></canvas>
    </div>
    <div class="card">
      <div class="card-title">High-risk transactions</div>
      <div class="table-wrap">
        <table class="table" id="riskTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Counterparty</th>
              <th class="num">Amount</th>
              <th>Rule</th>
              <th>Severity</th>
              <th class="num">Confidence</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const fmtEUR = (v) => {
  try { return new Intl.NumberFormat(undefined,{style:'currency',currency:'EUR'}).format(v); }
  catch(e){ return (v||0).toFixed(2) + " EUR"; }
};

let cashflowChart, riskChart, susTrendChart, cpChart;

function setRiskColor(cardEl, ratio){
  cardEl.classList.remove('risk-low','risk-med','risk-high');
  if (ratio >= 0.15) cardEl.classList.add('risk-high');
  else if (ratio >= 0.05) cardEl.classList.add('risk-med');
  else cardEl.classList.add('risk-low');
}

async function loadDashboard(){
  const caseId = "{{ selected_case_id }}";
  const res = await fetch(`/api/dashboard/${caseId}`);
  if(!res.ok) return;
  const data = await res.json();

  const k = data.kpis;
  document.getElementById('kpiInflows').innerText = fmtEUR(k.total_inflows);
  document.getElementById('kpiOutflows').innerText = fmtEUR(Math.abs(k.total_outflows));
  document.getElementById('kpiSuspicious').innerText = fmtEUR(k.suspicious_amount);
  document.getElementById('kpiOpenHits').innerText = `${k.open_rule_hits} open rule hits`;

  const cov = k.coverage || {};
  const covPct = (k.coverage_ratio || 0) * 100;
  document.getElementById('kpiCoverage').innerText = `${covPct.toFixed(0)}%`;
  document.getElementById('kpiGap').innerText =
    (cov.min_date && cov.max_date)
      ? `${cov.min_date} → ${cov.max_date} • longest gap ${cov.longest_gap_days}d`
      : `No data`;

  const denom = Math.max(1, Math.abs(k.total_outflows) + k.total_inflows);
  const suspiciousRatio = (k.suspicious_amount || 0) / denom;
  setRiskColor(document.getElementById('kpiSuspiciousCard'), suspiciousRatio);

  if (cashflowChart) cashflowChart.destroy();
  if (riskChart) riskChart.destroy();
  if (susTrendChart) susTrendChart.destroy();
  if (cpChart) cpChart.destroy();

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    animation: false
  };

  cashflowChart = new Chart(document.getElementById('cashflowChart'), {
    type: 'bar',
    data: {
      labels: data.monthly_cashflow.map(x => x.month),
      datasets: [
        { label: 'Inflows', data: data.monthly_cashflow.map(x => x.inflows) },
        { label: 'Outflows', data: data.monthly_cashflow.map(x => x.outflows) }
      ]
    },
    options: chartOptions
  });

  riskChart = new Chart(document.getElementById('riskChart'), {
    type: 'pie',
    data: {
      labels: ['LOW','REVIEW','HIGH'],
      datasets: [{
        data: [
          data.risk_distribution.LOW||0,
          data.risk_distribution.REVIEW||0,
          data.risk_distribution.HIGH||0
        ]
      }]
    },
    options: chartOptions
  });

  susTrendChart = new Chart(document.getElementById('susTrendChart'), {
    type: 'line',
    data: {
      labels: data.suspicious_trend.map(x => x.month),
      datasets: [{ label: 'Suspicious amount', data: data.suspicious_trend.map(x => x.amount) }]
    },
    options: chartOptions
  });

  cpChart = new Chart(document.getElementById('cpChart'), {
    type: 'bar',
    data: {
      labels: data.top_counterparties.map(x => x.counterparty),
      datasets: [{ label: 'Volume', data: data.top_counterparties.map(x => x.volume) }]
    },
    options: { ...chartOptions, indexAxis: 'y' }
  });

  const lc = data.notice_lifecycle || {};
  document.getElementById('lcDraft').innerText = lc.Draft||0;
  document.getElementById('lcGenerated').innerText = lc.Generated||0;
  document.getElementById('lcAccepted').innerText = lc.Accepted||0;
  document.getElementById('lcSent').innerText = lc.Sent||0;
  const total = (lc.Draft||0)+(lc.Generated||0)+(lc.Accepted||0)+(lc.Sent||0);
  const done = (lc.Sent||0);
  document.getElementById('lcProgress').style.width = (total ? (done/total*100) : 0).toFixed(0)+'%';

  const tbody = document.querySelector('#riskTable tbody');
  tbody.innerHTML = '';
  (data.high_risk || []).forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.date||''}</td>
      <td>${row.counterparty||''}</td>
      <td class="num">${fmtEUR(Math.abs(row.amount||0))}</td>
      <td>${row.rule_id||''}</td>
      <td>${row.severity||''}</td>
      <td class="num">${(row.confidence||0).toFixed(2)}</td>
      <td><a class="btn-sm" href="/notices">Create notice</a></td>
    `;
    tbody.appendChild(tr);
  });
}

loadDashboard();
</script>
{% endblock %}
